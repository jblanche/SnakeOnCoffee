var Database,DatabaseConfig,EventEmitter,Goodie,Server,Snake,SnakeEmitter,TwitterListener,checkCollisions,config,createGoodie,database,events,express,goodies,io,server,snakes,sys,tick,topTen,twitterListener,updateState,util,utils,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};exports.STAGE_WIDTH=49,exports.STAGE_HEIGHT=49,exports.SNAKE_LENGTH=8,config=require("./config"),exports.Goodie=Goodie=function(){function a(){this.x=Math.floor(Math.random()*config.STAGE_WIDTH),this.y=Math.floor(Math.random()*config.STAGE_HEIGHT),this.age=0}return a}(),Server=require("./server").Server,EventEmitter=require("events").EventEmitter,Snake=require("./snake").Snake,SnakeEmitter=require("./snake").SnakeEmitter,Goodie=require("./goodie").Goodie,TwitterListener=require("./twitterListener").TwitterListener,util=require("util"),Database=require("./database").Database,utils=require("./utils"),config=require("./config"),DatabaseConfig=require("./databaseConfig").DatabaseConfig,snakes={},goodies=[],topTen={},server=new Server(process.env.SNAKES_SERVER_PORT||5e3),twitterListener=new TwitterListener,database=new Database(DatabaseConfig),server.start(),twitterListener.watch(),SnakeEmitter.on("createPlayer",function(a){return database.createPlayer(a.name)}),SnakeEmitter.on("updateScore",function(a){return database.updateScore(a.name,a.score)}),database.on("topTen",function(a){return topTen=a}),server.on("Server.connection",function(a){var b;return b=new Snake(a),snakes[a]=b}),server.on("Server.disconnect",function(a){return delete snakes[a]}),server.on("Server.direction",function(a,b){return snakes[a].direction=b}),server.on("Server.name",function(a,b){return snakes[a].setName(b)}),twitterListener.on("newTweet",function(){return createGoodie()}),updateState=function(){var a,b,c,d,e,f,g;for(b in snakes)d=snakes[b],d.doStep();c=function(){var b,c,d;d=[];for(b=0,c=goodies.length;b<c;b++)a=goodies[b],a.age++>100&&d.push(a);return d}();for(f=0,g=c.length;f<g;f++)a=c[f],goodies.remove(a);return checkCollisions(),e=function(){var a;a=[];for(b in snakes)d=snakes[b],a.push(d.toJSON());return a}(),server.update(e,goodies,topTen)},checkCollisions=function(){var a,b,c,d,e,f,g,h,i,j;d=[];for(b in snakes){e=snakes[b],e.blocksSelf()&&d.push(e);for(f=0,h=goodies.length;f<h;f++)a=goodies[f],e.ateGoodie(a)&&(e.addGoodie(),goodies.remove(a));for(b in snakes)c=snakes[b],c!==e&&c.blocks(e)&&(d.push(e),c.addKill())}j=[];for(g=0,i=d.length;g<i;g++)e=d[g],j.push(e.reset());return j},createGoodie=function(){var a;return a=new Goodie,goodies.push(a)},tick=setInterval(updateState,100),io=require("socket.io"),express=require("express"),util=require("util"),EventEmitter=require("events").EventEmitter,exports.Server=Server=function(){function a(a){a==null&&(a=5001),this.autoClient=1,this.port=parseInt(process.env.PORT||a,10)}return __extends(a,EventEmitter),a.prototype.start=function(){return this.server=express.createServer(),this.server.use(express.static(__dirname+"/../public")),this.server.listen(this.port),this.listen()},a.prototype.listen=function(){var a=this;return this.socket=io.listen(this.server),this.socket.configure(function(){return a.socket.set("log level",1)}),this.socket.of("/snake").on("connection",function(b){return b.snakeId=a.autoClient,a.autoClient+=1,util.puts("Client "+b.snakeId+" connected"),a.emit("Server.connection",b.snakeId),b.emit("id",{id:b.snakeId}),b.on("direction",function(c){return a.emit("Server.direction",b.snakeId,c.direction)}),b.on("name",function(c){return a.emit("Server.name",b.snakeId,c.name)}),b.on("disconnect",function(){return util.puts("Client "+b.snakeId+" disconnected"),a.emit("Server.disconnect",b.snakeId)})})},a.prototype.update=function(a,b,c){return this.socket.of("/snake").emit("update",{snakes:a,goodies:b,topTen:{scores:c}})},a}(),sys=require("sys"),util=require("util"),events=require("events"),config=require("./config"),Database=require("./database").Database,exports.SnakeEmitter=SnakeEmitter=new events.EventEmitter,exports.Snake=Snake=function(){function a(a){this.id=a,this.kills=0,this.deaths=0,this.goodies=0,this.length=config.SNAKE_LENGTH,this.name="",this.reset(),this.color=Math.floor(Math.random()*16777215).toString(16)}return __extends(a,events.EventEmitter),a.prototype.setName=function(a){return this.name=a,SnakeEmitter.emit("createPlayer",{name:this.name})},a.prototype.toJSON=function(){return{elements:this.elements,goodies:this.goodies,kills:this.kills,deaths:this.deaths,color:this.color,name:this.name,score:this.score()}},a.prototype.score=function(){return this.goodies+this.kills},a.prototype.addKill=function(){return this.kills++,this.length=this.elements.unshift({x:-1,y:-1}),this.length},a.prototype.reset=function(){var a,b;return b=Math.floor(Math.random()*49),this.deaths++,this.goodies=this.kills=0,this.length=config.SNAKE_LENGTH,this.direction="right",this.elements=function(){var c,d;d=[];for(a=c=this.length;c<=1?a<=1:a>=1;c<=1?a++:a--)d.push({x:-a,y:b});return d}.call(this),this.emit("reset"),SnakeEmitter.emit("updateScore",{name:this.name,score:this.getScore()})},a.prototype.getScore=function(){return this.goodies*2+this.kills-this.deaths},a.prototype.doStep=function(){var a,b;for(a=0,b=this.length-1;0<=b?a<b:a>b;0<=b?a++:a--)this.moveTail(a);return this.moveHead(),this},a.prototype.addGoodie=function(){return this.length=this.elements.unshift({x:-1,y:-1}),this.goodies++,this.length},a.prototype.moveTail=function(a){return this.elements[a].x=this.elements[a+1].x,this.elements[a].y=this.elements[a+1].y},a.prototype.moveHead=function(){var a;a=this.length-1;switch(this.direction){case"left":this.elements[a].x-=1;break;case"right":this.elements[a].x+=1;break;case"up":this.elements[a].y-=1;break;case"down":this.elements[a].y+=1}this.elements[a].x<0&&(this.elements[a].x=config.STAGE_WIDTH),this.elements[a].y<0&&(this.elements[a].y=config.STAGE_HEIGHT),this.elements[a].x>config.STAGE_WIDTH&&(this.elements[a].x=0);if(this.elements[a].y>config.STAGE_HEIGHT)return this.elements[a].y=0},a.prototype.head=function(){return this.elements[this.length-1]},a.prototype.blocks=function(a){var b,c,d,e,f,g;d=a.head(),b=!1,g=this.elements;for(e=0,f=g.length;e<f;e++)c=g[e],d.x===c.x&&d.y===c.y&&(b=!0);return b},a.prototype.ateGoodie=function(a){var b;return a==null?!1:(b=this.head(),b.x===a.x&&b.y===a.y)},a.prototype.blocksSelf=function(){var a,b,c,d;b=this.head(),a=!1;for(c=0,d=this.length-1;0<=d?c<d:c>d;0<=d?c++:c--)b.x===this.elements[c].x&&b.y===this.elements[c].y&&(a=!0);return a},a}(),Array.prototype.remove=function(a){var b,c;if((b=this.indexOf(a))>-1)return[].splice.apply(this,[b,b-b+1].concat(c=[])),c}