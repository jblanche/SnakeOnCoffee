var EventEmitter,Goodie,Server,Snake,checkCollisions,config,createGoodie,express,goodies,io,server,snakes,sys,tick,updateState,util,utils,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},__bind=function(a,b){return function(){return a.apply(b,arguments)}};exports.STAGE_WIDTH=49,exports.STAGE_HEIGHT=49,exports.SNAKE_LENGTH=8,config=require("./config"),exports.Goodie=Goodie=function(){function a(){this.x=Math.floor(Math.random()*config.STAGE_WIDTH),this.y=Math.floor(Math.random()*config.STAGE_HEIGHT)}return a}(),Server=require("./server").Server,EventEmitter=require("events").EventEmitter,Snake=require("./snake").Snake,Goodie=require("./goodie").Goodie,utils=require("./utils"),config=require("./config"),snakes={},goodies=[],server=new Server(5e3),server.start(),server.on("Server.connection",function(a){var b;return b=new Snake(a),snakes[a]=b}),server.on("Server.disconnect",function(a){return delete snakes[a]}),server.on("Server.direction",function(a,b){return snakes[a].direction=b}),updateState=function(){var a,b;for(a in snakes)b=snakes[a],b.doStep();return checkCollisions(),server.update(snakes,goodies)},checkCollisions=function(){var a,b,c,d,e,f,g,h,i,j;d=[];for(b in snakes){e=snakes[b],e.blocksSelf()&&d.push(e);for(f=0,h=goodies.length;f<h;f++)a=goodies[f],e.ateGoodie(a)&&(e.addGoodie(),goodies.remove(a),createGoodie());for(b in snakes)c=snakes[b],c!==e&&c.blocks(e)&&(d.push(e),c.addKill())}j=[];for(g=0,i=d.length;g<i;g++)e=d[g],j.push(e.reset());return j},createGoodie=function(){var a;return a=new Goodie,goodies.push(a)},tick=setInterval(updateState,100),createGoodie(),io=require("socket.io"),express=require("express"),sys=require("sys"),util=require("util"),EventEmitter=require("events").EventEmitter,exports.Server=Server=function(){function a(a){a==null&&(a=5e3),this.autoClient=1,this.port=parseInt(process.env.PORT||a,10)}return __extends(a,EventEmitter),a.prototype.start=function(){return this.server=express.createServer(),this.server.use(express.static(__dirname+"/../public")),this.server.listen(this.port),this.listen()},a.prototype.listen=function(){return this.socket=io.listen(this.server),this.socket.on("connection",__bind(function(a){return a.snakeId=this.autoClient,this.autoClient+=1,this.emit("Server.connection",a.snakeId),sys.puts("Client "+a.snakeId+" connected"),a.send(JSON.stringify({type:"id",value:a.snakeId})),a.on("message",__bind(function(b){return b=JSON.parse(b),this.emit("Server.direction",a.snakeId,b.direction)},this)),a.on("disconnect",__bind(function(){return sys.puts("Client "+a.snakeId+" disconnected"),this.emit("Server.disconnect",a.snakeId)},this))},this))},a.prototype.update=function(a,b){return this.socket.broadcast(JSON.stringify({type:"update",snakes:a,goodies:b}))},a}(),sys=require("sys"),util=require("util"),config=require("./config"),exports.Snake=Snake=function(){function a(a){this.id=a,this.reset(),this.kills=0,this.deaths=0,this.goodies=0,this.length=config.SNAKE_LENGTH}return a.prototype.addKill=function(){return this.kills++,this.length=this.elements.unshift({x:-1,y:-1}),this.length},a.prototype.reset=function(){var a,b;return b=Math.floor(Math.random()*49),this.deaths++,this.length=config.SNAKE_LENGTH,this.direction="right",this.elements=function(){var c,d;d=[];for(a=c=this.length;c<=1?a<=1:a>=1;c<=1?a++:a--)d.push({x:-a,y:b});return d}.call(this)},a.prototype.doStep=function(){var a,b;for(a=0,b=this.length-1;0<=b?a<b:a>b;0<=b?a++:a--)this.moveTail(a);return this.moveHead(),this},a.prototype.addGoodie=function(){return this.length=this.elements.unshift({x:-1,y:-1}),this.goodies++,this.length},a.prototype.moveTail=function(a){return this.elements[a].x=this.elements[a+1].x,this.elements[a].y=this.elements[a+1].y},a.prototype.moveHead=function(){var a;a=this.length-1;switch(this.direction){case"left":this.elements[a].x-=1;break;case"right":this.elements[a].x+=1;break;case"up":this.elements[a].y-=1;break;case"down":this.elements[a].y+=1}this.elements[a].x<0&&(this.elements[a].x=config.STAGE_WIDTH),this.elements[a].y<0&&(this.elements[a].y=config.STAGE_HEIGHT),this.elements[a].x>config.STAGE_WIDTH&&(this.elements[a].x=0);if(this.elements[a].y>config.STAGE_HEIGHT)return this.elements[a].y=0},a.prototype.head=function(){return this.elements[this.length-1]},a.prototype.blocks=function(a){var b,c,d,e,f,g;d=a.head(),b=!1,g=this.elements;for(e=0,f=g.length;e<f;e++)c=g[e],d.x===c.x&&d.y===c.y&&(b=!0);return b},a.prototype.ateGoodie=function(a){var b;return b=this.head(),b.x===a.x&&b.y===a.y},a.prototype.blocksSelf=function(){var a,b,c,d;b=this.head(),a=!1;for(c=0,d=this.length-1;0<=d?c<d:c>d;0<=d?c++:c--)b.x===this.elements[c].x&&b.y===this.elements[c].y&&(a=!0);return a},a}(),Array.prototype.remove=function(a){var b,c;if((b=this.indexOf(a))>-1)return[].splice.apply(this,[b,b-b+1].concat(c=[])),c}